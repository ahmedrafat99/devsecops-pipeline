name: Close Dependabot PRs

on:
  workflow_dispatch:
  pull_request_target:
    types: [opened]

permissions:
  contents: read
  pull-requests: write

jobs:
  close-opened-dependabot-pr:
    if: github.event_name == 'pull_request_target' && github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Close current Dependabot PR
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              state: 'closed'
            });

  close-all-existing-dependabot-prs:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Close all open Dependabot PRs
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prs = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            let closed = 0;
            for (const pr of prs) {
              if (pr.user && pr.user.login === 'dependabot[bot]') {
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: pr.number,
                  state: 'closed'
                });
                closed += 1;
              }
            }

            core.summary
              .addHeading('Dependabot PR Cleanup')
              .addRaw(`Closed ${closed} open Dependabot PR(s).`)
              .write();
