name: PHP DevSecOps Pipeline
# trigger: manual touch to run workflow

on:
  push:
    branches: [main]
    paths:
      - "php/VulnerableApp-php/**"
      - ".github/workflows/php-devsecops.yml"
  pull_request:
    branches: [main]
    paths:
      - "php/VulnerableApp-php/**"
      - ".github/workflows/php-devsecops.yml"
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  php-devsecops:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Detect PHP project directory
        id: project
        shell: bash
        run: |
          if [ -d "php/VulnerableApp-php" ]; then
            echo "dir=php/VulnerableApp-php" >> "$GITHUB_OUTPUT"
            echo "project_found=true" >> "$GITHUB_OUTPUT"
            if [ -f "php/VulnerableApp-php/composer.json" ]; then
              echo "has_composer=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_composer=false" >> "$GITHUB_OUTPUT"
            fi
            if [ -f "php/VulnerableApp-php/Dockerfile" ]; then
              echo "has_dockerfile=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_dockerfile=false" >> "$GITHUB_OUTPUT"
            fi
            if [ -f "php/VulnerableApp-php/compose.yml" ] || [ -f "php/VulnerableApp-php/docker-compose.yml" ]; then
              echo "has_compose=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_compose=false" >> "$GITHUB_OUTPUT"
            fi
            if [ -f "php/VulnerableApp-php/Dockerfile" ] && grep -Eiq 'EXPOSE[[:space:]]+80|apache|httpd|nginx|php:.*apache|caddy' "php/VulnerableApp-php/Dockerfile"; then
              echo "supports_dast=true" >> "$GITHUB_OUTPUT"
            else
              echo "supports_dast=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No recognizable PHP project found under php/. Marking run as skipped."
            echo "dir=php" >> "$GITHUB_OUTPUT"
            echo "project_found=false" >> "$GITHUB_OUTPUT"
            echo "has_composer=false" >> "$GITHUB_OUTPUT"
            echo "has_dockerfile=false" >> "$GITHUB_OUTPUT"
            echo "has_compose=false" >> "$GITHUB_OUTPUT"
            echo "supports_dast=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create report directory
        shell: bash
        run: mkdir -p "${{ steps.project.outputs.dir }}/reports"

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Secrets scan - Gitleaks (SARIF)
        id: gitleaks_step
        shell: bash
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}:/repo" zricethezav/gitleaks:latest detect \
            --source="/repo" \
            --no-git \
            --report-format sarif \
            --report-path "/repo/reports/gitleaks.sarif" \
            --exit-code 0
        continue-on-error: true

      - name: Secrets scan - TruffleHog (JSON)
        shell: bash
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}:/repo" trufflesecurity/trufflehog:latest filesystem \
            --directory=/repo \
            --json \
            > "${{ steps.project.outputs.dir }}/reports/trufflehog.json" || true
          if [ ! -s "${{ steps.project.outputs.dir }}/reports/trufflehog.json" ]; then
            echo "[]" > "${{ steps.project.outputs.dir }}/reports/trufflehog.json"
          fi
        continue-on-error: true

      - name: SAST - Semgrep (SARIF)
        id: semgrep_step
        shell: bash
        run: |
          python -m pip install --upgrade pip semgrep
          semgrep scan --config auto --sarif --output "${{ steps.project.outputs.dir }}/reports/semgrep.sarif" "${{ steps.project.outputs.dir }}"
        continue-on-error: true

      - name: SCA - Trivy filesystem scan
        id: trivy_deps_step
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: ${{ steps.project.outputs.dir }}
          scanners: vuln,misconfig,secret
          vuln-type: os,library
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          format: sarif
          output: ${{ steps.project.outputs.dir }}/reports/trivy-deps.sarif
        continue-on-error: true

      - name: Build Docker image
        id: build_image_step
        if: steps.project.outputs.has_dockerfile == 'true'
        shell: bash
        run: docker build -t vulnerable-php:ci -f ${{ steps.project.outputs.dir }}/Dockerfile ${{ steps.project.outputs.dir }}
        continue-on-error: true

      - name: Build app image via docker-compose fallback
        id: build_compose_step
        if: steps.build_image_step.outcome != 'success' && steps.project.outputs.has_compose == 'true'
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          compose_file=""
          if [ -f compose.yml ]; then
            compose_file="compose.yml"
          elif [ -f docker-compose.yml ]; then
            compose_file="docker-compose.yml"
          fi
          if [ -n "$compose_file" ]; then
            docker compose -f "$compose_file" build
            first_service="$(docker compose -f "$compose_file" config --services | head -n 1 || true)"
            if [ -n "$first_service" ]; then
              image_id="$(docker compose -f "$compose_file" images -q "$first_service" | head -n 1 || true)"
              if [ -n "$image_id" ]; then
                docker tag "$image_id" vulnerable-php:ci
              fi
            fi
            docker compose -f "$compose_file" images || true
            docker image inspect vulnerable-php:ci >/dev/null 2>&1 || true
          fi
        continue-on-error: true

      - name: Resolve image scan readiness
        id: image_ready_step
        if: always()
        shell: bash
        run: |
          if docker image inspect vulnerable-php:ci >/dev/null 2>&1; then
            echo "ready=true" >> "$GITHUB_OUTPUT"
          else
            echo "ready=false" >> "$GITHUB_OUTPUT"
          fi
        continue-on-error: true

      - name: Container scan - Trivy image (SARIF)
        id: trivy_image_step
        if: steps.image_ready_step.outputs.ready == 'true'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: image
          image-ref: vulnerable-php:ci
          scanners: vuln,secret
          vuln-type: os,library
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          format: sarif
          output: ${{ steps.project.outputs.dir }}/reports/trivy-image.sarif
        continue-on-error: true

      - name: Start app container for DAST
        id: start_app_step
        if: steps.image_ready_step.outputs.ready == 'true' && steps.project.outputs.supports_dast == 'true'
        shell: bash
        run: |
          docker network create zap-net || true
          docker run -d --name php-app -p 8080:80 --network zap-net vulnerable-php:ci
          for i in {1..45}; do
            if docker run --rm --network zap-net curlimages/curl:8.10.1 -fsS http://php-app/ > /dev/null; then
              echo "PHP app is reachable for ZAP."
              exit 0
            fi
            sleep 2
          done
          docker logs php-app || true
          exit 1
        continue-on-error: true

      - name: DAST - OWASP ZAP baseline scan
        id: zap_step
        if: steps.start_app_step.outcome == 'success'
        shell: bash
        run: |
          chmod -R 777 "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}/reports" || true
          docker run --rm --network zap-net \
            --user root \
            -v "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}/reports:/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://php-app \
            -r zap-report.html \
            -J zap-report.json \
            -x zap-report.xml \
            -w zap-warnings.md \
            -I
        continue-on-error: true

      - name: Preserve ZAP baseline artifacts
        if: always()
        shell: bash
        env:
          REPORT_DIR: ${{ steps.project.outputs.dir }}/reports
        run: |
          [ -f "$REPORT_DIR/zap-report.html" ] && cp "$REPORT_DIR/zap-report.html" "$REPORT_DIR/zap-baseline-report.html" || true
          [ -f "$REPORT_DIR/zap-report.json" ] && cp "$REPORT_DIR/zap-report.json" "$REPORT_DIR/zap-baseline-report.json" || true
          [ -f "$REPORT_DIR/zap-report.xml" ] && cp "$REPORT_DIR/zap-report.xml" "$REPORT_DIR/zap-baseline-report.xml" || true
          [ -f "$REPORT_DIR/zap-warnings.md" ] && cp "$REPORT_DIR/zap-warnings.md" "$REPORT_DIR/zap-baseline-warnings.md" || true

      - name: DAST - OWASP ZAP full (active) scan
        id: zap_full_step
        if: steps.start_app_step.outcome == 'success'
        shell: bash
        run: |
          chmod -R 777 "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}/reports" || true
          docker run --rm --network zap-net \
            --user root \
            -v "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}/reports:/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable zap-full-scan.py \
            -t http://php-app \
            -m 5 \
            -a \
            -r zap-report.html \
            -J zap-report.json \
            -x zap-report.xml \
            -w zap-warnings.md \
            -I
        continue-on-error: true

      - name: Normalize ZAP artifacts
        if: always()
        shell: bash
        env:
          REPORT_DIR: ${{ steps.project.outputs.dir }}/reports
          SUPPORTS_DAST: ${{ steps.project.outputs.supports_dast }}
        run: |
          if [ "$SUPPORTS_DAST" != "true" ]; then
            echo '{"status":"skipped","message":"DAST skipped: Docker image is not a web app exposing an HTTP endpoint."}' > "$REPORT_DIR/zap-report.json"
            echo '<html><body><h1>ZAP skipped</h1><p>Docker image is not a web app exposing an HTTP endpoint.</p></body></html>' > "$REPORT_DIR/zap-report.html"
            echo '<report status="skipped" message="DAST skipped: Docker image is not a web app exposing an HTTP endpoint."/>' > "$REPORT_DIR/zap-report.xml"
            echo '# ZAP warnings' > "$REPORT_DIR/zap-warnings.md"
            exit 0
          fi
          if [ ! -f "$REPORT_DIR/zap-report.html" ]; then
            echo '<html><body><h1>ZAP report missing</h1></body></html>' > "$REPORT_DIR/zap-report.html"
          fi
          if [ ! -f "$REPORT_DIR/zap-report.json" ]; then
            echo '{"status":"missing","message":"ZAP did not generate JSON report in this run."}' > "$REPORT_DIR/zap-report.json"
          fi
          if [ ! -f "$REPORT_DIR/zap-report.xml" ]; then
            echo '<report status="missing" message="ZAP did not generate XML report in this run."/>' > "$REPORT_DIR/zap-report.xml"
          fi
          if [ ! -f "$REPORT_DIR/zap-warnings.md" ]; then
            echo '# ZAP warnings' > "$REPORT_DIR/zap-warnings.md"
          fi

      - name: Stop app container
        if: always()
        shell: bash
        run: |
          docker rm -f php-app || true
          docker network rm zap-net || true

      - name: Ensure report placeholders before SARIF upload
        if: always()
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          [ -f reports/semgrep.sarif ] || echo '{"runs":[]}' > reports/semgrep.sarif
          [ -f reports/trivy-deps.sarif ] || echo '{"runs":[]}' > reports/trivy-deps.sarif
          [ -f reports/trivy-image.sarif ] || echo '{"runs":[]}' > reports/trivy-image.sarif
          [ -f reports/gitleaks.sarif ] || echo '{"runs":[]}' > reports/gitleaks.sarif
          [ -f reports/trufflehog.json ] || echo '{"status":"missing"}' > reports/trufflehog.json

      - name: Upload SARIF - Semgrep
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/semgrep.sarif
          category: "/tool:semgrep/language:php"
        continue-on-error: true

      - name: Upload SARIF - Trivy deps
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/trivy-deps.sarif
          category: "/tool:trivy-deps/language:php"
        continue-on-error: true

      - name: Upload SARIF - Trivy image
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/trivy-image.sarif
          category: "/tool:trivy-image/language:php"
        continue-on-error: true

      - name: Upload SARIF - Gitleaks
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/gitleaks.sarif
          category: "/tool:gitleaks/language:php"
        continue-on-error: true

      - name: Build summary
        if: always()
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        env:
          SEMGREP_OUTCOME: ${{ steps.semgrep_step.outcome }}
          TRIVY_DEPS_OUTCOME: ${{ steps.trivy_deps_step.outcome }}
          TRIVY_IMAGE_OUTCOME: ${{ steps.trivy_image_step.outcome }}
          GITLEAKS_OUTCOME: ${{ steps.gitleaks_step.outcome }}
          ZAP_BASE_OUTCOME: ${{ steps.zap_step.outcome }}
          ZAP_FULL_OUTCOME: ${{ steps.zap_full_step.outcome }}
        run: |
          python - <<'PY'
          import os
          import json
          from collections import Counter
          from pathlib import Path

          report_dir = Path("reports")
          report_dir.mkdir(exist_ok=True)
          project_dir = "${{ steps.project.outputs.dir }}"

          def text(name: str) -> str:
            p = report_dir / name
            if not p.exists():
              return ""
            return p.read_text(encoding="utf-8", errors="replace")

          def load_json(name: str):
            raw = text(name)
            if not raw.strip():
              return None
            try:
              return json.loads(raw)
            except json.JSONDecodeError:
              return None

          def parse_sarif(name: str):
            data = load_json(name)
            if not data:
              return {"status": "missing_file", "total": 0, "levels": {}, "top_rules": []}
            runs = data.get("runs", [])
            if not runs:
              return {"status": "no_runs", "total": 0, "levels": {}, "top_rules": []}
            run = runs[0]
            results = run.get("results", []) or []
            if not results:
              return {"status": "no_findings", "total": 0, "levels": {}, "top_rules": [], "severities": {}}
            rules = run.get("tool", {}).get("driver", {}).get("rules", []) or []
            default_level = {r.get("id"): r.get("defaultConfiguration", {}).get("level") for r in rules}
            # Prefer tool-provided severity tags when available (e.g., Trivy).
            severity_by_rule = {}
            for rule in rules:
              rid = rule.get("id")
              tags = rule.get("properties", {}).get("tags", []) or []
              sev = None
              for t in tags:
                tt = str(t).upper()
                if tt in {"CRITICAL", "HIGH", "MEDIUM", "LOW"}:
                  sev = tt
                  break
              if rid and sev:
                severity_by_rule[rid] = sev
            lv = Counter()
            sev = Counter()
            level_to_sev = {
              "error": "CRITICAL",
              "warning": "MEDIUM",
              "note": "LOW",
              "none": "LOW",
            }
            rule_counts = Counter()
            for item in results:
              lvl = item.get("level") or default_level.get(item.get("ruleId")) or "unknown"
              lv[lvl] += 1
              rid = item.get("ruleId")
              tool_sev = severity_by_rule.get(rid)
              if tool_sev:
                sev[tool_sev] += 1
              else:
                sev[level_to_sev.get(str(lvl).lower(), "LOW")] += 1
              rid = item.get("ruleId") or "unknown"
              rule_counts[rid] += 1
            return {
              "status": "ok",
              "total": len(results),
              "levels": dict(sorted(lv.items())),
              "severities": dict(sorted(sev.items())),
              "top_rules": rule_counts.most_common(5),
            }

          def parse_trufflehog():
            raw = text("trufflehog.json")
            if raw == "":
              return "missing"
            lines = [ln.strip() for ln in raw.splitlines() if ln.strip()]
            # trufflehog JSON output is newline-delimited objects when findings exist
            if len(lines) == 1 and lines[0] == "[]":
              return "findings=0"
            findings = 0
            for ln in lines:
              try:
                obj = json.loads(ln)
                if isinstance(obj, list):
                  findings += len(obj)
                elif isinstance(obj, dict):
                  findings += 1
              except json.JSONDecodeError:
                pass
            return f"findings={findings}"

          def parse_zap(name: str):
            data = load_json(name)
            if not data:
              return {"status": "missing", "notes": "report not found"}
            if isinstance(data, dict) and data.get("status") == "missing":
              return {"status": "missing", "notes": data.get("message", "no message")}
            if isinstance(data, dict) and data.get("status") == "skipped":
              return {"status": "skipped", "notes": data.get("message", "DAST skipped")}
            if not isinstance(data, dict):
              return {"status": "available", "alerts": "?", "instances": "?", "levels": "-", "normalized": "-", "notes": "unexpected format"}
            sites = data.get("site", []) or []
            risk_map = {"0": "info", "1": "low", "2": "medium", "3": "high"}
            levels = Counter()
            alert_types = 0
            instances_total = 0
            for site in sites:
              alerts = site.get("alerts", []) or []
              alert_types += len(alerts)
              for a in alerts:
                risk = risk_map.get(str(a.get("riskcode", "")), "unknown")
                inst = a.get("instances", []) or []
                n = len(inst) if inst else 1
                levels[risk] += n
                instances_total += n
            levels_text = ", ".join(f"{k}:{v}" for k, v in sorted(levels.items())) if levels else "-"
            # Normalize ZAP risk levels to the requested five-band scale.
            normalized = Counter()
            normalized["CRITICAL"] += 0
            normalized["HIGH"] += levels.get("high", 0)
            normalized["MEDIUM"] += levels.get("medium", 0)
            normalized["LOW"] += levels.get("low", 0) + levels.get("info", 0) + levels.get("unknown", 0)
            ntext = ", ".join(f"{k}:{normalized[k]}" for k in ["CRITICAL", "HIGH", "MEDIUM", "LOW"]) or "-"
            return {
              "status": "available",
              "alerts": alert_types,
              "instances": instances_total,
              "levels": levels_text,
              "normalized": ntext,
              "critical": normalized["CRITICAL"],
              "high": normalized["HIGH"],
              "medium": normalized["MEDIUM"],
              "low": normalized["LOW"],
            }

          semgrep = parse_sarif("semgrep.sarif")
          trivy_deps = parse_sarif("trivy-deps.sarif")
          trivy_image = parse_sarif("trivy-image.sarif")
          gitleaks = parse_sarif("gitleaks.sarif")
          trufflehog_text = parse_trufflehog()
          semgrep_outcome = (os.getenv("SEMGREP_OUTCOME") or "").strip()
          trivy_deps_outcome = (os.getenv("TRIVY_DEPS_OUTCOME") or "").strip()
          trivy_image_outcome = (os.getenv("TRIVY_IMAGE_OUTCOME") or "").strip()
          gitleaks_outcome = (os.getenv("GITLEAKS_OUTCOME") or "").strip()
          zap_base_outcome = (os.getenv("ZAP_BASE_OUTCOME") or "").strip()
          zap_full_outcome = (os.getenv("ZAP_FULL_OUTCOME") or "").strip()

          def sev_count(obj: dict, key: str) -> int:
            return int(obj.get("severities", {}).get(key, 0))

          def tool_status(sarif_obj: dict, step_outcome: str) -> str:
            if step_outcome == "failure":
              return "failed"
            if step_outcome == "cancelled":
              return "cancelled"
            if step_outcome == "skipped":
              return "skipped"
            status = sarif_obj.get("status", "unknown")
            if status == "ok":
              return "ok"
            if status == "no_findings":
              return "no_findings"
            if status in {"missing_file", "no_runs"}:
              return "missing_report"
            return status

          def level_text(obj: dict) -> str:
            return ", ".join(f"{k.upper()}:{v}" for k, v in obj.get("levels", {}).items()) if obj.get("levels") else "-"

          def top_text(obj: dict) -> str:
            def short_rule(rule_id: str) -> str:
              if len(rule_id) <= 40:
                return rule_id
              return rule_id[:37] + "..."
            return ", ".join(f"{short_rule(r)}:{c}" for r, c in obj.get("top_rules", [])[:2]) or "-"

          def zap_status(zap_obj: dict, step_outcome: str) -> str:
            if step_outcome == "failure":
              return "failed"
            if step_outcome == "cancelled":
              return "cancelled"
            if step_outcome == "skipped":
              return "skipped"
            return zap_obj.get("status", "unknown")

          def zap_row(tool_name: str, zap_obj: dict, step_outcome: str) -> str:
            available = zap_obj.get("status") == "available"
            return (
              f"| {tool_name} | {zap_status(zap_obj, step_outcome)} | "
              f"{zap_obj.get('alerts', '-') if available else '-'} ({zap_obj.get('instances', '-') if available else '-'}) | "
              f"{zap_obj.get('critical', 0) if available else '-'} | "
              f"{zap_obj.get('high', 0) if available else '-'} | "
              f"{zap_obj.get('medium', 0) if available else '-'} | "
              f"{zap_obj.get('low', 0) if available else '-'} | "
              f"step={step_outcome or '-'}; levels={zap_obj.get('levels', '-')}; status={zap_obj.get('status', '-')} "
              f"{('; ' + zap_obj.get('notes')) if zap_obj.get('notes') else ''} |"
            )

          zap_baseline = parse_zap("zap-baseline-report.json")
          zap_full = parse_zap("zap-report.json")

          lines = [
              "# PHP DevSecOps Summary",
              "",
              f"- Project directory: `{project_dir}`",
              "",
              "| Tool | Status | Findings | Critical | High | Medium | Low | Notes |",
              "|---|---|---:|---:|---:|---:|---:|---|",
              f"| Semgrep (SARIF) | {tool_status(semgrep, semgrep_outcome)} | {semgrep['total']} | {sev_count(semgrep, 'CRITICAL')} | {sev_count(semgrep, 'HIGH')} | {sev_count(semgrep, 'MEDIUM')} | {sev_count(semgrep, 'LOW')} | step={semgrep_outcome or '-'}; levels={level_text(semgrep)}; top={top_text(semgrep)} |",
              f"| Trivy deps (SARIF) | {tool_status(trivy_deps, trivy_deps_outcome)} | {trivy_deps['total']} | {sev_count(trivy_deps, 'CRITICAL')} | {sev_count(trivy_deps, 'HIGH')} | {sev_count(trivy_deps, 'MEDIUM')} | {sev_count(trivy_deps, 'LOW')} | step={trivy_deps_outcome or '-'}; levels={level_text(trivy_deps)}; top={top_text(trivy_deps)} |",
              f"| Trivy image (SARIF) | {tool_status(trivy_image, trivy_image_outcome)} | {trivy_image['total']} | {sev_count(trivy_image, 'CRITICAL')} | {sev_count(trivy_image, 'HIGH')} | {sev_count(trivy_image, 'MEDIUM')} | {sev_count(trivy_image, 'LOW')} | step={trivy_image_outcome or '-'}; levels={level_text(trivy_image)}; top={top_text(trivy_image)} |",
              f"| Gitleaks (SARIF) | {tool_status(gitleaks, gitleaks_outcome)} | {gitleaks['total']} | {sev_count(gitleaks, 'CRITICAL')} | {sev_count(gitleaks, 'HIGH')} | {sev_count(gitleaks, 'MEDIUM')} | {sev_count(gitleaks, 'LOW')} | step={gitleaks_outcome or '-'}; levels={level_text(gitleaks)}; top={top_text(gitleaks)} |",
              f"| TruffleHog (JSON) | {'ok' if trufflehog_text.startswith('findings=') else 'missing_report'} | {trufflehog_text.replace('findings=', '') if trufflehog_text.startswith('findings=') else '-'} | - | - | - | - | {trufflehog_text} |",
              zap_row("OWASP ZAP Baseline (JSON)", zap_baseline, zap_base_outcome),
              zap_row("OWASP ZAP Full (active, JSON)", zap_full, zap_full_outcome),
              "",
              "## Files",
          ]
          for p in sorted(report_dir.glob("**/*")):
            if p.is_file():
              lines.append(f"- `{p.as_posix()}` ({p.stat().st_size} bytes)")
          (report_dir / "summary.md").write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Publish summary to workflow run
        if: always()
        shell: bash
        run: |
          SUMMARY_FILE="${{ steps.project.outputs.dir }}/reports/summary.md"
          if [ -f "$SUMMARY_FILE" ]; then
            cat "$SUMMARY_FILE" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "# PHP DevSecOps Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "Summary file missing: \`$SUMMARY_FILE\`" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Fallback report files
        if: always()
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          [ -f reports/semgrep.sarif ] || echo '{"runs":[]}' > reports/semgrep.sarif
          [ -f reports/trivy-deps.sarif ] || echo '{"runs":[]}' > reports/trivy-deps.sarif
          [ -f reports/trivy-image.sarif ] || echo '{"runs":[]}' > reports/trivy-image.sarif
          [ -f reports/gitleaks.sarif ] || echo '{"runs":[]}' > reports/gitleaks.sarif
          [ -f reports/trufflehog.json ] || echo '{"status":"missing"}' > reports/trufflehog.json
          [ -f reports/summary.md ] || cat > reports/summary.md <<'EOF'
          # PHP DevSecOps Summary
          Fallback summary file.
          EOF

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: php-devsecops-reports
          path: ${{ steps.project.outputs.dir }}/reports
