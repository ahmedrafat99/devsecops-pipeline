name: PHP DevSecOps Pipeline

on:
  push:
    branches: [main]
    paths:
      - "php/**"
      - ".github/workflows/php-devsecops.yml"
  pull_request:
    branches: [main]
    paths:
      - "php/**"
      - ".github/workflows/php-devsecops.yml"
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  php-devsecops:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Detect PHP project directory
        id: project
        shell: bash
        run: |
          if [ -d "php/VulnerableApp-php" ]; then
            echo "dir=php/VulnerableApp-php" >> "$GITHUB_OUTPUT"
            if [ -f "php/VulnerableApp-php/composer.json" ]; then
              echo "has_composer=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_composer=false" >> "$GITHUB_OUTPUT"
            fi
          elif [ -f "php/composer.json" ]; then
            echo "dir=php" >> "$GITHUB_OUTPUT"
            echo "has_composer=true" >> "$GITHUB_OUTPUT"
          elif [ -d "php" ] && [ -f "php/Dockerfile" -o -f "php/package.json" ]; then
            echo "dir=php" >> "$GITHUB_OUTPUT"
            echo "has_composer=false" >> "$GITHUB_OUTPUT"
          else
            echo "No recognizable PHP project found under php/."
            exit 1
          fi

      - name: Create report directory
        shell: bash
        run: mkdir -p "${{ steps.project.outputs.dir }}/reports"

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer

      - name: Secrets scan - Gitleaks (SARIF)
        shell: bash
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}:/repo" zricethezav/gitleaks:latest detect \
            --source="/repo" \
            --report-format sarif \
            --report-path "/repo/reports/gitleaks.sarif" \
            --exit-code 0
        continue-on-error: true

      - name: Secrets scan - TruffleHog (JSON)
        shell: bash
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}:/repo" trufflesecurity/trufflehog:latest filesystem \
            --directory=/repo \
            --json \
            > "${{ steps.project.outputs.dir }}/reports/trufflehog.json" || true
          if [ ! -s "${{ steps.project.outputs.dir }}/reports/trufflehog.json" ]; then
            echo "[]" > "${{ steps.project.outputs.dir }}/reports/trufflehog.json"
          fi
        continue-on-error: true

      - name: Install dependencies
        if: steps.project.outputs.has_composer == 'true'
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: composer install --no-interaction --prefer-dist || true

      - name: SCA - Composer audit
        if: steps.project.outputs.has_composer == 'true'
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          composer audit --format json > reports/composer-audit.json || true
          composer audit > reports/composer-audit.txt || true
        continue-on-error: true

      - name: SCA - Composer not present marker
        if: steps.project.outputs.has_composer != 'true'
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          echo '{"status":"skipped","reason":"composer.json not found in detected php project"}' > reports/composer-audit.json
          echo "Composer audit skipped: composer.json not found." > reports/composer-audit.txt

      - name: Lint - PHP syntax
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          find . -type f -name "*.php" -print0 | xargs -0 -I{} php -l "{}" > reports/php-lint.txt 2>&1 || true
        continue-on-error: true

      - name: SAST - Semgrep (SARIF)
        shell: bash
        run: |
          python -m pip install --upgrade pip semgrep
          semgrep scan --config auto --sarif --output "${{ steps.project.outputs.dir }}/reports/semgrep.sarif" "${{ steps.project.outputs.dir }}"
        continue-on-error: true

      - name: SCA - Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: ${{ steps.project.outputs.dir }}
          vuln-type: library
          severity: CRITICAL,HIGH,MEDIUM
          format: sarif
          output: ${{ steps.project.outputs.dir }}/reports/trivy-deps.sarif
        continue-on-error: true

      - name: Build Docker image
        shell: bash
        run: docker build -t vulnerable-php:ci -f ${{ steps.project.outputs.dir }}/Dockerfile ${{ steps.project.outputs.dir }}
        continue-on-error: true

      - name: Container scan - Trivy image (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: vulnerable-php:ci
          vuln-type: os,library
          severity: CRITICAL,HIGH,MEDIUM
          format: sarif
          output: ${{ steps.project.outputs.dir }}/reports/trivy-image.sarif
        continue-on-error: true

      - name: Start app container for DAST
        shell: bash
        run: |
          docker network create zap-net || true
          docker run -d --name php-app -p 8080:80 --network zap-net vulnerable-php:ci
          for i in {1..45}; do
            if docker run --rm --network zap-net curlimages/curl:8.10.1 -fsS http://php-app/ > /dev/null; then
              echo "PHP app is reachable for ZAP."
              exit 0
            fi
            sleep 2
          done
          docker logs php-app || true
          exit 1
        continue-on-error: true

      - name: DAST - OWASP ZAP baseline scan
        shell: bash
        run: |
          chmod -R 777 "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}/reports" || true
          docker run --rm --network zap-net \
            --user root \
            -v "${GITHUB_WORKSPACE}/${{ steps.project.outputs.dir }}/reports:/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://php-app \
            -r zap-report.html \
            -J zap-report.json \
            -x zap-report.xml \
            -w zap-warnings.md \
            -I
        continue-on-error: true

      - name: Normalize ZAP artifacts
        if: always()
        shell: bash
        env:
          REPORT_DIR: ${{ steps.project.outputs.dir }}/reports
        run: |
          if [ ! -f "$REPORT_DIR/zap-report.html" ]; then
            echo '<html><body><h1>ZAP report missing</h1></body></html>' > "$REPORT_DIR/zap-report.html"
          fi
          if [ ! -f "$REPORT_DIR/zap-report.json" ]; then
            echo '{"status":"missing","message":"ZAP did not generate JSON report in this run."}' > "$REPORT_DIR/zap-report.json"
          fi
          if [ ! -f "$REPORT_DIR/zap-report.xml" ]; then
            echo '<report status="missing" message="ZAP did not generate XML report in this run."/>' > "$REPORT_DIR/zap-report.xml"
          fi
          if [ ! -f "$REPORT_DIR/zap-warnings.md" ]; then
            echo '# ZAP warnings' > "$REPORT_DIR/zap-warnings.md"
          fi

      - name: Stop app container
        if: always()
        shell: bash
        run: |
          docker rm -f php-app || true
          docker network rm zap-net || true

      - name: Upload SARIF - Semgrep
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/semgrep.sarif
          category: "/tool:semgrep/language:php"
        continue-on-error: true

      - name: Upload SARIF - Trivy deps
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/trivy-deps.sarif
          category: "/tool:trivy-deps/language:php"
        continue-on-error: true

      - name: Upload SARIF - Trivy image
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/trivy-image.sarif
          category: "/tool:trivy-image/language:php"
        continue-on-error: true

      - name: Upload SARIF - Gitleaks
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.project.outputs.dir }}/reports/gitleaks.sarif
          category: "/tool:gitleaks/language:php"
        continue-on-error: true

      - name: Build summary
        if: always()
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          python - <<'PY'
          import json
          import re
          from collections import Counter
          from pathlib import Path

          report_dir = Path("reports")
          report_dir.mkdir(exist_ok=True)
          has_composer = "${{ steps.project.outputs.has_composer }}" == "true"
          project_dir = "${{ steps.project.outputs.dir }}"

          def text(name: str) -> str:
            p = report_dir / name
            if not p.exists():
              return ""
            return p.read_text(encoding="utf-8", errors="replace")

          def load_json(name: str):
            raw = text(name)
            if not raw.strip():
              return None
            try:
              return json.loads(raw)
            except json.JSONDecodeError:
              return None

          def parse_sarif(name: str):
            data = load_json(name)
            if not data:
              return {"status": "missing", "total": 0, "levels": {}, "top_rules": []}
            runs = data.get("runs", [])
            if not runs:
              return {"status": "empty", "total": 0, "levels": {}, "top_rules": []}
            run = runs[0]
            results = run.get("results", []) or []
            rules = run.get("tool", {}).get("driver", {}).get("rules", []) or []
            default_level = {r.get("id"): r.get("defaultConfiguration", {}).get("level") for r in rules}
            # Prefer tool-provided severity tags when available (e.g., Trivy).
            severity_by_rule = {}
            for rule in rules:
              rid = rule.get("id")
              tags = rule.get("properties", {}).get("tags", []) or []
              sev = None
              for t in tags:
                tt = str(t).upper()
                if tt in {"CRITICAL", "HIGH", "MEDIUM", "LOW"}:
                  sev = tt
                  break
              if rid and sev:
                severity_by_rule[rid] = sev
            lv = Counter()
            sev = Counter()
            level_to_sev = {
              "error": "CRITICAL",
              "warning": "MEDIUM",
              "note": "LOW",
              "none": "LOW",
            }
            rule_counts = Counter()
            for item in results:
              lvl = item.get("level") or default_level.get(item.get("ruleId")) or "unknown"
              lv[lvl] += 1
              rid = item.get("ruleId")
              tool_sev = severity_by_rule.get(rid)
              if tool_sev:
                sev[tool_sev] += 1
              else:
                sev[level_to_sev.get(str(lvl).lower(), "LOW")] += 1
              rid = item.get("ruleId") or "unknown"
              rule_counts[rid] += 1
            return {
              "status": "ok",
              "total": len(results),
              "levels": dict(sorted(lv.items())),
              "severities": dict(sorted(sev.items())),
              "top_rules": rule_counts.most_common(5),
            }

          def parse_composer():
            data = load_json("composer-audit.json")
            if not data:
              return "missing"
            if isinstance(data, dict) and data.get("status") == "skipped":
              return f"skipped ({data.get('reason', 'no reason')})"
            if isinstance(data, dict):
              # composer audit can return advisories by package
              advisories = data.get("advisories", {})
              if isinstance(advisories, dict):
                vuln_count = sum(len(v or []) for v in advisories.values())
                return f"vulnerabilities={vuln_count}; affected_packages={len(advisories)}"
            return "available (format not recognized)"

          def parse_php_lint():
            raw = text("php-lint.txt")
            if not raw:
              return "missing"
            errors = len(re.findall(r"Parse error|Fatal error", raw))
            ok = len(re.findall(r"No syntax errors detected", raw))
            return f"files_checked={ok}; parse_errors={errors}"

          def parse_trufflehog():
            raw = text("trufflehog.json")
            if raw == "":
              return "missing"
            lines = [ln.strip() for ln in raw.splitlines() if ln.strip()]
            # trufflehog JSON output is newline-delimited objects when findings exist
            if len(lines) == 1 and lines[0] == "[]":
              return "findings=0"
            findings = 0
            for ln in lines:
              try:
                obj = json.loads(ln)
                if isinstance(obj, list):
                  findings += len(obj)
                elif isinstance(obj, dict):
                  findings += 1
              except json.JSONDecodeError:
                pass
            return f"findings={findings}"

          def parse_zap():
            data = load_json("zap-report.json")
            if not data:
              return "missing"
            if isinstance(data, dict) and data.get("status") == "missing":
              return f"missing ({data.get('message', 'no message')})"
            if not isinstance(data, dict):
              return "available (unexpected format)"
            sites = data.get("site", []) or []
            risk_map = {"0": "info", "1": "low", "2": "medium", "3": "high"}
            levels = Counter()
            alert_types = 0
            instances_total = 0
            for site in sites:
              alerts = site.get("alerts", []) or []
              alert_types += len(alerts)
              for a in alerts:
                risk = risk_map.get(str(a.get("riskcode", "")), "unknown")
                inst = a.get("instances", []) or []
                n = len(inst) if inst else 1
                levels[risk] += n
                instances_total += n
            levels_text = ", ".join(f"{k}:{v}" for k, v in sorted(levels.items())) if levels else "-"
            # Normalize ZAP risk levels to the requested five-band scale.
            normalized = Counter()
            normalized["HIGH"] += levels.get("high", 0)
            normalized["MEDIUM"] += levels.get("medium", 0)
            normalized["LOW"] += levels.get("low", 0) + levels.get("info", 0) + levels.get("unknown", 0)
            ntext = ", ".join(
              f"{k}:{normalized[k]}" for k in ["CRITICAL", "HIGH", "MEDIUM", "LOW"] if normalized.get(k, 0) > 0
            ) or "-"
            return f"alerts={alert_types}; instances={instances_total}; levels={levels_text}; normalized={ntext}"

          semgrep = parse_sarif("semgrep.sarif")
          trivy_deps = parse_sarif("trivy-deps.sarif")
          trivy_image = parse_sarif("trivy-image.sarif")
          gitleaks = parse_sarif("gitleaks.sarif")

          def sarif_line(name: str, obj: dict) -> str:
            levels = ", ".join(f"{k}:{v}" for k, v in obj["levels"].items()) if obj["levels"] else "-"
            order = ["CRITICAL", "HIGH", "MEDIUM", "LOW"]
            severities = ", ".join(f"{k}:{obj['severities'][k]}" for k in order if k in obj.get("severities", {})) or "-"
            top_rules = ", ".join(f"{r}:{c}" for r, c in obj["top_rules"]) if obj["top_rules"] else "-"
            return f"{name}: status={obj['status']}; findings={obj['total']}; levels={levels}; severities={severities}; top_rules={top_rules}"

          lines = [
              "# PHP DevSecOps Summary",
              "",
              f"- Project directory: `{project_dir}`",
              f"- Composer file detected: `{has_composer}`",
              "",
              "| Tool | Detailed Result |",
              "|---|---|",
              f"| Composer audit | {parse_composer()} |",
              f"| PHP lint | {parse_php_lint()} |",
              f"| Semgrep (SARIF) | {sarif_line('semgrep', semgrep)} |",
              f"| Trivy deps (SARIF) | {sarif_line('trivy-deps', trivy_deps)} |",
              f"| Trivy image (SARIF) | {sarif_line('trivy-image', trivy_image)} |",
              f"| Gitleaks (SARIF) | {sarif_line('gitleaks', gitleaks)} |",
              f"| TruffleHog (JSON) | {parse_trufflehog()} |",
              f"| OWASP ZAP (JSON) | {parse_zap()} |",
              "",
              "## Files",
          ]
          for p in sorted(report_dir.glob("**/*")):
            if p.is_file():
              lines.append(f"- `{p.as_posix()}` ({p.stat().st_size} bytes)")
          (report_dir / "summary.md").write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Publish summary to workflow run
        if: always()
        shell: bash
        run: cat "${{ steps.project.outputs.dir }}/reports/summary.md" >> "$GITHUB_STEP_SUMMARY"

      - name: Fallback report files
        if: always()
        shell: bash
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          [ -f reports/semgrep.sarif ] || echo '{"runs":[]}' > reports/semgrep.sarif
          [ -f reports/trivy-deps.sarif ] || echo '{"runs":[]}' > reports/trivy-deps.sarif
          [ -f reports/trivy-image.sarif ] || echo '{"runs":[]}' > reports/trivy-image.sarif
          [ -f reports/gitleaks.sarif ] || echo '{"runs":[]}' > reports/gitleaks.sarif
          [ -f reports/trufflehog.json ] || echo '{"status":"missing"}' > reports/trufflehog.json
          [ -f reports/composer-audit.json ] || echo '{"status":"missing"}' > reports/composer-audit.json
          [ -f reports/summary.md ] || cat > reports/summary.md <<'EOF'
          # PHP DevSecOps Summary
          Fallback summary file.
          EOF

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: php-devsecops-reports
          path: ${{ steps.project.outputs.dir }}/reports
